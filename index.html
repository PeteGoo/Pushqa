<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Pushqa by PeteGoo</title>
    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="javascripts/respond.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!--[if lt IE 8]>
    <link rel="stylesheet" href="stylesheets/ie.css">
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

  </head>
  <body>

      <div id="header">
        <nav>
          <li class="fork"><a href="https://github.com/PeteGoo/Pushqa">Fork On GitHub</a></li>
          <li class="downloads"><a href="https://github.com/PeteGoo/Pushqa/zipball/master">ZIP</a></li>
          <li class="downloads"><a href="https://github.com/PeteGoo/Pushqa/tarball/master">TAR</a></li>
          <li class="title">DOWNLOADS</li>
        </nav>
      </div><!-- end header -->

    <div class="wrapper">

      <section>
        <div id="title">
          <h1>Pushqa</h1>
          <p>An HTTP push messaging library with oData and Linq subscriptions for server side filtering of reactive events</p>
          <hr>
          <span class="credits left">Project maintained by <a href="https://github.com/PeteGoo">PeteGoo</a></span>
          <span class="credits right">Hosted on GitHub Pages &mdash; Theme by <a href="http://twitter.com/#!/michigangraham">mattgraham</a></span>
        </div>

        <h1>Pushqa</h1>

<h2>Overview</h2>

<p>Pushqa is a .Net library that allows the filtering of incoming push events from a server to be performed server-side.</p>

<p>It allows the consumer to define queries over event streams so that events that are being emitted server side can be filtered and constrained by client side code. The queries are serialized and executed server side rather than sending all the events to the client for client side filtering.</p>

<p>Pushqa uses Microsoft's Reactive Extensions (Rx) expressions over an HTTP connection with the queries serialized using the oData URI specification. The current transport pipeline supported is SignalR though more pipelines may be added in the future. By default, messages are serialized using JSON. The message service is hosted in an ASP.Net Web project running in IIS.</p>

<h2>Get it on NuGet</h2>

<p>Pushqa is now available on <a href="http://nuget.org/packages?q=pushqa" target="_blank">NuGet</a>.</p>

<iframe src="http://player.vimeo.com/video/40514930" width="600" height="420" frameborder="0" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe><p><a href="http://vimeo.com/40514930">Pushqa Introduction Demo</a> from <a href="http://vimeo.com/user3050044">Peter Goodman</a> on <a href="http://vimeo.com">Vimeo</a>.</p>

<h2>Implementing a queryable event stream</h2>

<p>Server side implementation is easy, we only need to define our server context class with one or more event stream properties in terms of an Rx IQbservable.</p>

<p>First though, lets create an ASP.Net Web Application and add the following code to the Application_Start of the Global.asax file so that incoming requests to the 'events' path of our app gets redirected to Pushqa.</p>

<div class="highlight">
<pre>    <span class="n">RouteTable</span><span class="p">.</span><span class="n">Routes</span><span class="p">.</span><span class="n">MapConnection</span><span class="p">&lt;</span><span class="n">QueryablePushService</span><span class="p">&lt;</span><span class="n">MyPushContext</span><span class="p">&gt;&gt;(</span><span class="s">"events"</span><span class="p">,</span> <span class="s">"events/{*operation}"</span><span class="p">);</span>
</pre>
</div>


<p>Now add the push context class that exposes the observable Rx event stream. </p>

<div class="highlight">
<pre>    <span class="k">public</span> <span class="k">class</span> <span class="nc">MyPushContext</span> <span class="p">{</span>
        <span class="k">public</span> <span class="n">IQbservable</span><span class="p">&lt;</span><span class="n">MyMessage</span><span class="p">&gt;</span> <span class="n">OneSecondTimer</span> <span class="p">{</span>
            <span class="k">get</span> <span class="p">{</span> 
                <span class="k">return</span> <span class="n">Observable</span><span class="p">.</span><span class="n">Interval</span><span class="p">(</span><span class="n">TimeSpan</span><span class="p">.</span><span class="n">FromSeconds</span><span class="p">(</span><span class="m">1</span><span class="p">))</span>
                    <span class="p">.</span><span class="n">Timestamp</span><span class="p">()</span>
                    <span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">i</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="n">MyMessage</span> <span class="p">{</span>
                        <span class="n">MessageId</span> <span class="p">=</span> <span class="n">i</span><span class="p">.</span><span class="n">Value</span><span class="p">,</span> 
                        <span class="n">TimeStamp</span> <span class="p">=</span> <span class="n">i</span><span class="p">.</span><span class="n">Timestamp</span><span class="p">,</span> 
                        <span class="n">Description</span> <span class="p">=</span> <span class="s">"Message"</span>
                    <span class="p">})</span>
                    <span class="p">.</span><span class="n">AsQbservable</span><span class="p">();</span> 
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
</pre>
</div>


<p>Notice that the above Rx event stream is simply a 1 second timer projected into our custom message class. For more ways to easily create Rx event streams (e.g. from standard events) see the examples <a href="http://rxwiki.wikidot.com/101samples#toc5" title="Rx 101 Samples">here</a>.</p>

<h2>Consuming from Javascript</h2>

<p>The above event stream will be exposed over SignalR so a javascript can use the standard SignalR API to listen to events.</p>

<div class="highlight">
<pre>    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span><span class="nt">&gt;</span>
        <span class="nx">$</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">connection</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">connection</span><span class="p">(</span><span class="s1">'../events/OneSecondTimer'</span><span class="p">,</span> <span class="p">{</span> <span class="nx">$filter</span><span class="o">:</span> <span class="s2">"(MessageId mod 2) eq 0"</span><span class="p">,</span> <span class="nx">$skip</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">$top</span><span class="o">:</span> <span class="mi">5</span> <span class="p">});</span>

            <span class="nx">connection</span><span class="p">.</span><span class="nx">received</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">Type</span> <span class="o">==</span> <span class="s1">'Completed'</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">connection</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
                    <span class="nx">$</span><span class="p">(</span><span class="s1">'#messages'</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s1">'&lt;li&gt;Complete&lt;/li&gt;'</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">$</span><span class="p">(</span><span class="s1">'#messages'</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s1">'&lt;li&gt;'</span> <span class="o">+</span> <span class="nx">data</span><span class="p">.</span><span class="nx">Message</span> <span class="o">+</span> <span class="s1">'&lt;/li&gt;'</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">});</span>

            <span class="nx">connection</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>

            <span class="nx">$</span><span class="p">(</span><span class="s2">"#connect"</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="nx">connection</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
            <span class="p">});</span>

            <span class="nx">$</span><span class="p">(</span><span class="s2">"#disconnect"</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="nx">connection</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
            <span class="p">});</span>
        <span class="p">});</span>
    <span class="nt">&lt;/script&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"button"</span> <span class="na">id=</span><span class="s">"connect"</span> <span class="na">value=</span><span class="s">"Connect"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"button"</span> <span class="na">id=</span><span class="s">"disconnect"</span> <span class="na">value=</span><span class="s">"Disconnect"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;ul</span> <span class="na">id=</span><span class="s">"messages"</span><span class="nt">&gt;&lt;/ul&gt;</span>
</pre>
</div>


<p>Notice that, because Pushqa uses oData's URI syntax, we can filter the event stream to every second event, we can skip the first 2 events after the subscription starts and we will only receive 5 messages.</p>

<p>Or you can now use Reactive Extensions for Javascript which makes it much easier to respond to the different type of events.</p>

<div class="highlight">
<pre>    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span><span class="nt">&gt;</span>
        <span class="nx">$</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="c1">// Setup our connection</span>
            <span class="kd">var</span> <span class="nx">connection</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">connection</span><span class="p">(</span><span class="s1">'../events/OneSecondTimer/'</span><span class="p">,</span> <span class="p">{</span> <span class="nx">$filter</span><span class="o">:</span> <span class="s2">"(MessageId mod 2) eq 0"</span><span class="p">,</span> <span class="nx">$skip</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">$top</span><span class="o">:</span> <span class="mi">5</span> <span class="p">});</span>

            <span class="c1">// Append each message received</span>
            <span class="nx">connection</span><span class="p">.</span><span class="nx">asObservable</span><span class="p">().</span><span class="nx">subscribe</span><span class="p">(</span>
                <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
                    <span class="c1">// onNext</span>
                    <span class="nx">$</span><span class="p">(</span><span class="s1">'#messages'</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s1">'&lt;li&gt;'</span> <span class="o">+</span> <span class="nx">data</span> <span class="o">+</span> <span class="s1">'&lt;/li&gt;'</span><span class="p">);</span>
                <span class="p">},</span>
                <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
                    <span class="c1">// onError</span>
                    <span class="nx">$</span><span class="p">(</span><span class="s1">'#messages'</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s1">'&lt;li&gt;Error: '</span> <span class="o">+</span> <span class="nx">error</span> <span class="o">+</span> <span class="s1">'&lt;/li&gt;'</span><span class="p">);</span>
                <span class="p">},</span>
                <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                    <span class="c1">// onCompleted</span>
                    <span class="nx">$</span><span class="p">(</span><span class="s1">'#messages'</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s1">'&lt;li&gt;Complete&lt;/li&gt;'</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">);</span>

            <span class="nx">connection</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>

            <span class="nx">$</span><span class="p">(</span><span class="s2">"#connect"</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="nx">connection</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
            <span class="p">});</span>

            <span class="nx">$</span><span class="p">(</span><span class="s2">"#disconnect"</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="nx">connection</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
            <span class="p">});</span>
        <span class="p">});</span>

    <span class="nt">&lt;/script&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"button"</span> <span class="na">id=</span><span class="s">"connect"</span> <span class="na">value=</span><span class="s">"Connect"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"button"</span> <span class="na">id=</span><span class="s">"disconnect"</span> <span class="na">value=</span><span class="s">"Disconnect"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;ul</span> <span class="na">id=</span><span class="s">"messages"</span><span class="nt">&gt;&lt;/ul&gt;</span>
</pre>
</div>


<h2>Consuming using the Client Linq API</h2>

<p>Pushqa includes a linq provider to allow the event stream to be filtered using LINQ. Firstly we need to implement our client side EventProvider class.</p>

<div class="highlight">
<pre>    <span class="k">public</span> <span class="k">class</span> <span class="nc">MyPushEventProvider</span> <span class="p">:</span> <span class="n">EventProvider</span> <span class="p">{</span>
        <span class="k">public</span> <span class="nf">MyPushEventProvider</span><span class="p">()</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="k">new</span> <span class="n">Uri</span><span class="p">(</span><span class="s">"http://localhost/Sample.Web/events"</span><span class="p">))</span> <span class="p">{</span> <span class="p">}</span>

        <span class="k">public</span> <span class="n">EventQuerySource</span><span class="p">&lt;</span><span class="n">MyMessage</span><span class="p">&gt;</span> <span class="n">OneSecondTimer</span> <span class="p">{</span>
            <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">CreateQuery</span><span class="p">&lt;</span><span class="n">MyMessage</span><span class="p">&gt;(</span><span class="s">"OneSecondTimer"</span><span class="p">);</span> <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
</pre>
</div>


<p>Then we simply use the EventQuerySource property to construct our query and subscribe.</p>

<div class="highlight">
<pre>    <span class="k">public</span> <span class="k">class</span> <span class="nc">MainWindowViewModel</span> <span class="p">{</span>

        <span class="k">public</span> <span class="nf">MainWindowViewModel</span><span class="p">()</span> <span class="p">{</span>
            <span class="c1">// Setup the event stream subscription</span>
            <span class="n">MyPushEventProvider</span> <span class="n">eventProvider</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MyPushEventProvider</span><span class="p">();</span>
            <span class="p">(</span><span class="k">from</span> <span class="n">myEvent</span> <span class="k">in</span> <span class="n">eventProvider</span><span class="p">.</span><span class="n">OneSecondTimer</span>
             <span class="k">where</span> <span class="n">myEvent</span><span class="p">.</span><span class="n">MessageId</span> <span class="p">%</span> <span class="m">2</span> <span class="p">==</span> <span class="m">0</span> 
             <span class="k">select</span> <span class="n">myEvent</span><span class="p">)</span>
             <span class="p">.</span><span class="n">Take</span><span class="p">(</span><span class="m">5</span><span class="p">)</span>
             <span class="p">.</span><span class="n">AsObservable</span><span class="p">()</span>
             <span class="p">.</span><span class="n">ObserveOnDispatcher</span><span class="p">()</span>
             <span class="p">.</span><span class="n">Catch</span><span class="p">&lt;</span><span class="n">MyMessage</span><span class="p">,</span> <span class="n">Exception</span><span class="p">&gt;(</span><span class="n">e</span> <span class="p">=&gt;</span> <span class="n">Observable</span><span class="p">.</span><span class="n">Return</span><span class="p">(</span><span class="k">new</span> <span class="n">MyMessage</span> <span class="p">{</span><span class="n">Description</span> <span class="p">=</span> <span class="n">e</span><span class="p">.</span><span class="n">Message</span><span class="p">}))</span>
             <span class="p">.</span><span class="n">Subscribe</span><span class="p">(</span><span class="n">message</span> <span class="p">=&gt;</span> <span class="n">messages</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">message</span><span class="p">),</span> 
                <span class="p">()</span> <span class="p">=&gt;</span> <span class="n">Messages</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">MyMessage</span> <span class="p">{</span><span class="n">Description</span> <span class="p">=</span> <span class="s">"Complete"</span><span class="p">}));</span>

        <span class="p">}</span>

        <span class="k">private</span> <span class="k">readonly</span> <span class="n">ObservableCollection</span><span class="p">&lt;</span><span class="n">MyMessage</span><span class="p">&gt;</span> <span class="n">messages</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ObservableCollection</span><span class="p">&lt;</span><span class="n">MyMessage</span><span class="p">&gt;();</span>

        <span class="k">public</span> <span class="n">ObservableCollection</span><span class="p">&lt;</span><span class="n">MyMessage</span><span class="p">&gt;</span> <span class="n">Messages</span> <span class="p">{</span>
            <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">messages</span><span class="p">;</span> <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
</pre>
</div>


<p>Notice how the standard LINQ query syntax works for filtering while Take and Skip are also implemented. </p>

<p>AsObservable() created our client side observable event stream and allows us to define further Rx operators that will execute on the client. In this case we monitor the events on the WPF dispatcher, handle errors and push messages onto the Messages collection. </p>

<p>Complete is called when the server event stream has ended e.g. when the "Take" count is met.</p>

<p>Â©Peter Goodman</p>
      </section>

    </div>
    <!--[if !IE]><script>fixScale(document);</script><!--<![endif]-->
  </body>
</html>